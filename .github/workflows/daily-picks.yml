      - name: Build SMART PICKS (Bouzas / Fenix style)
        run: |
          python - << 'PY'
          import pandas as pd, os
          df = pd.read_csv("value_picks_pro.csv")

          # Focus on mid-range upset candidates
          smart = df[
              (df['ev_per_unit'] > 0) &
              (df['blended_prob'] >= 0.40) &
              (df['best_odds'].between(2.20, 4.50)) &
              (df['confidence'] >= 50)
          ].copy()

          # Keep only one side of a match (higher EV side)
          smart.insert(0, "match_id", smart.apply(lambda r: " :: ".join(sorted([str(r['player']), str(r['opponent'])])), axis=1))
          smart = smart.sort_values("ev_per_unit", ascending=False).groupby("match_id", as_index=False).head(1)

          # Select relevant columns
          cols = ["tour","surface","commence_time_utc","player","opponent",
                  "blended_prob","best_odds","ev_per_unit","kelly_fraction","confidence"]

          smart = smart.sort_values(["ev_per_unit","confidence"], ascending=False).head(5)[cols]

          # Fallback: if empty, take top 3 EV from whole dataset
          if smart.empty:
              fallback = df[(df['ev_per_unit']>0)].copy()
              fallback.insert(0, "match_id", fallback.apply(lambda r: " :: ".join(sorted([str(r['player']), str(r['opponent'])])), axis=1))
              fallback = fallback.sort_values("ev_per_unit", ascending=False).groupby("match_id", as_index=False).head(1)
              smart = fallback.sort_values(["ev_per_unit","confidence"], ascending=False).head(3)[cols]

          smart.to_csv("smart_picks.csv", index=False)

          def md(df):
              if df.empty: return "_No picks_"
              d=df.round(4)
              return "| " + " | ".join(d.columns) + " |\n" + "| " + " | ".join(["---"]*len(d.columns)) + " |\n" + \
                     "\n".join("| " + " | ".join(map(str,row)) + " |" for row in d.values)

          def bullets(df):
              if df.empty: return "_No picks_"
              out=[]
              for _,r in df.iterrows():
                  out.append(f"- {r['player']} vs {r['opponent']} @ {r['best_odds']:.2f} "
                             f"(p={r['blended_prob']:.2f}, EV/u={r['ev_per_unit']:.2f})")
              return "\n".join(out)

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
              f.write("## ðŸŽ¯ SMART PICKS â€“ Mid-range Upsets\n")
              f.write(md(smart) + "\n\n")
              f.write("### Quick list\n")
              f.write(bullets(smart) + "\n")
          PY
