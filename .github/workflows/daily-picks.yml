name: Daily Tennis Picks (Auto Elo)

on:
  schedule:
    - cron: "0 8 * * *"  # Runs daily at 08:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ------------------------------
      # GENERATE ELO FILES
      # ------------------------------
      - name: Generate ATP/WTA Elo
        run: |
          python - <<'PYCODE'
          from elo_module import calculate_elo  # Make sure this exists
          import pandas as pd
          atp_matches = pd.read_csv("data/atp_matches.csv")
          wta_matches = pd.read_csv("data/wta_matches.csv")

          atp_elo_df = calculate_elo(atp_matches).sort_values("elo", ascending=False)
          wta_elo_df = calculate_elo(wta_matches).sort_values("elo", ascending=False)

          # Save in /data and root so the script finds them
          atp_elo_df.to_csv("data/atp_elo.csv", index=False)
          wta_elo_df.to_csv("data/wta_elo.csv", index=False)
          atp_elo_df.to_csv("atp_elo.csv", index=False)
          wta_elo_df.to_csv("wta_elo.csv", index=False)
          PYCODE

      # ------------------------------
      # RUN YOUR PICKS SCRIPT
      # ------------------------------
      - name: Run tennis value picks
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          python tennis_value_picks_pro.py --region eu --out value_picks_pro.csv

      # ------------------------------
      # UPLOAD RESULTS
      # ------------------------------
      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: results-eu
          path: value_picks_pro.csv
